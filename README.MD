Devops Infra
============

Cборка
------
- **Установите go**

Подойдет go 1.11, следуйте инструкциям https://golang.org/doc/install
- **Скачайте исходники приложения**

Простой способ - установить переменную `GOPATH` на нужную директорию,  и скачать с помощью `go get`:
 ```
 mkdir devops_infra
 export GOPATH=/path/to/devops_infra
 cd devops_infra
 go get gitlab.com/tfs18f-ekb-devops/public/application.git
 ```
- **Соберите приложение**

 Перейдите в проект и соберите его:
 ```
 cd src/gitlab.com/tfs18f-ekb-devops/public/application.git
 go build
 ```

 При успешной компиляции в корне проекта появится файл `application.git`

Запуск
------
- **Перенесите файлы приложения в папку `/playbooks/files`**

Нужно перенести как бинарный исполняемый файл, так и статические ресурсы папкой `static/`

- **Разверните тестовое окружение**

Тестовое окружение разворачивается с помощью Vagrant.
Виртуальным машинам нужен ssh ключ для аутентификации, поэтому убедитесь,
что у вас есть сгенерированный ssh ключ с названием `id_rsa` в папке `~/.ssh`
Если его нету, то сгенерируйте с помощью `ssh-keygen`

После чего поднимите виртуальные окружение:
```
vagrant up
```

- **Установите зависимости и задеплойте сервисы приложения**

```
ansible-galaxy install -r requirements.yml -p roles_galaxy

sudo ansible-playbook --vault-id vault_pas playbooks/bootstrap.yml -i environments/dev/hosts.ini
```
Пароль для vault хранится в vault_pas, который для этого проекта находится в корне, но в реальном проекте не должен быть там.  

После этого Ansible должен задеплоить сервисы PostgresSQL, Redis и приложения на хосты `192.168.1.[2-4]`

Откройте приложение в браузере по адресу `192.168.1.4:8080`


todo
------
- воспользоваться каким-нибудь бандлером и разворачивать сервис приложения одним файлом (docker?)
- делать так, чтобы ansible и vagrant брали хосты тестового окружения из одного места, чтобы избежать дублирования
- написать скрипт сборки-деплоя-с-нуля
